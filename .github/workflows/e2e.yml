name: E2E Tests (Nightly)

on:
  # Run every night at 2 AM UTC
  schedule:
    - cron: '0 2 * * *'

  # Allow manual trigger
  workflow_dispatch:

jobs:
  e2e:
    name: Run E2E Parser Validation
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'yarn'

      - name: Install dependencies
        run: yarn install --frozen-lockfile

      - name: Build project
        run: yarn build

      - name: Run E2E tests
        id: e2e
        run: yarn test:e2e
        continue-on-error: true

      - name: Check E2E results
        id: check
        run: |
          if [ "${{ steps.e2e.outcome }}" == "failure" ]; then
            echo "status=failed" >> $GITHUB_OUTPUT
            echo "‚ùå E2E tests failed - external APIs may have changed"
          else
            echo "status=success" >> $GITHUB_OUTPUT
            echo "‚úÖ E2E tests passed"
          fi

      - name: Create issue on E2E failure
        if: steps.check.outputs.status == 'failed'
        uses: actions/github-script@v7
        with:
          script: |
            const date = new Date().toISOString().split('T')[0];
            const title = `üö® E2E Tests Failed - ${date}`;
            const body = `## E2E Test Failure Report

            **Date:** ${date}
            **Workflow:** ${{ github.workflow }}
            **Run:** ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}

            ### What happened?
            The nightly E2E tests failed, which means one or more parsers are no longer working correctly against live external APIs.

            ### Possible causes:
            - External API structure changed
            - External service is temporarily down
            - Network issues
            - Parser logic needs updating

            ### Next steps:
            1. Check the workflow logs for specific parser failures
            2. Manually test the failing parsers
            3. Update parser code if API structure changed
            4. Update E2E tests if needed

            ### Affected parsers:
            Check the [workflow run](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}) for details.

            ---
            *This issue was automatically created by the E2E test workflow.*`;

            // Check if an issue already exists (search by title only, ignore labels)
            const issues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
            });

            const existingIssue = issues.data.find(issue =>
              issue.title.includes('E2E Tests Failed')
            );

            if (existingIssue) {
              // Update existing issue
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: existingIssue.number,
                body: `## New Failure: ${date}\n\nWorkflow run: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}`,
              });
            } else {
              // Create new issue (labels will be created automatically if they don't exist)
              await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: title,
                body: body,
                labels: ['e2e-failure', 'automated', 'bug'],
              });
            }

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: e2e-test-results-${{ github.run_number }}
          path: coverage/
          retention-days: 30
          if-no-files-found: ignore

  # Send notification on failure
  notify:
    name: Send Notification
    runs-on: ubuntu-latest
    needs: e2e
    if: failure()
    steps:
      - name: Send webhook notification
        if: secrets.E2E_NOTIFICATION_WEBHOOK_URL != ''
        run: |
          curl -k -X POST "${{ secrets.E2E_NOTIFICATION_WEBHOOK_URL }}" \
            -H "Content-Type: application/json" \
            -d '{
              "event": "e2e_tests_failed",
              "repository": "${{ github.repository }}",
              "workflow": "${{ github.workflow }}",
              "run_url": "${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}",
              "timestamp": "${{ github.event.repository.updated_at }}"
            }' || echo "Webhook notification failed (optional)"

      - name: Send email notification
        uses: dawidd6/action-send-mail@v3
        if: always()
        with:
          server_address: smtp.gmail.com
          server_port: 587
          username: ${{ secrets.EMAIL_USERNAME }}
          password: ${{ secrets.EMAIL_PASSWORD }}
          subject: "‚ö†Ô∏è E2E Tests Failed - ${{ github.repository }}"
          to: ${{ secrets.NOTIFICATION_EMAIL }}
          from: GitHub Actions <${{ secrets.EMAIL_USERNAME }}>
          body: |
            E2E Tests failed for ${{ github.repository }}

            Workflow: ${{ github.workflow }}
            Run ID: ${{ github.run_id }}
            Triggered by: ${{ github.actor }}

            View details: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}

            A GitHub issue has been automatically created or updated with details.
          ignore_cert: true
          convert_markdown: true
        continue-on-error: true
